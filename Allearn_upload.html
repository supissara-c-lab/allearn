<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Upload Sheet (Logic)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<h2>Upload Sheet</h2>

<p>
  PDF File:
  <input type="file" id="pdfFile" accept="application/pdf">
</p>

<p>
  ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó:
  <input type="text" id="sheetName">
</p>

<p>
  ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ä‡∏µ‡∏ó:
  <br>
  <textarea id="sheetDesc" rows="4" cols="50"
    placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡∏¢‡πà‡∏≠"></textarea>
</p>

<p>
  ‡∏ß‡∏¥‡∏ä‡∏≤:
  <select id="subjectSelect">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
  </select>
</p>

<p>
  ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå:
  <select id="professorSelect">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå --</option>
  </select>
</p>

<button id="uploadBtn">UPLOAD</button>

<script>
/* ================= SUPABASE ================= */
const supabaseClient = supabase.createClient(
  "https://ctfrqwehpvpldtiojedb.supabase.co",
  "sb_publishable_YHDQnG7VsNgb4O4i6MPN5g_lgU5eOGI"
)

/* ================= FIXED ================= */
const IDACC = "f2327b71-2cc2-45ac-9394-f4a8484dde89"
const IDMAJOR = "M01"

/* ================= ELEMENT ================= */
const subjectSelect = document.getElementById("subjectSelect")
const professorSelect = document.getElementById("professorSelect")
const uploadBtn = document.getElementById("uploadBtn")

/* ================= LOAD SUBJECT ================= */
async function loadSubjects() {
  const { data, error } = await supabaseClient
    .from("Subject")
    .select("idsubject, subject_name")
    .order("subject_name")

  if (error) {
    alert("‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    console.error(error)
    return
  }

  data.forEach(s => {
    const opt = document.createElement("option")
    opt.value = s.idsubject
    opt.textContent = s.subject_name
    subjectSelect.appendChild(opt)
  })
}
loadSubjects()

/* ================= LOAD PROFESSOR BY SUBJECT ================= */
subjectSelect.onchange = async () => {
  const idsubject = subjectSelect.value
  professorSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå --</option>`

  if (!idsubject) return

  const { data, error } = await supabaseClient
    .from("professor_subject")
    .select("idprofessor, Professor(name, surname)")
    .eq("idsubject", idsubject)

  if (error) {
    alert("‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    console.error(error)
    return
  }

  data.forEach(p => {
    const opt = document.createElement("option")
    opt.value = p.idprofessor
    opt.textContent = `${p.Professor.name} ${p.Professor.surname}`
    professorSelect.appendChild(opt)
  })
}

/* ================= UPLOAD ================= */
uploadBtn.onclick = async () => {
  const file = document.getElementById("pdfFile").files[0]
  const sheetName = document.getElementById("sheetName").value.trim()
  const sheetDesc = document.getElementById("sheetDesc").value.trim()
  const idsubject = subjectSelect.value
  const idprofessor = professorSelect.value

  if (!file || !sheetName || !idsubject || !idprofessor) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö")
    return
  }

  if (file.type !== "application/pdf") {
    alert("‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PDF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô")
    return
  }

  uploadBtn.disabled = true
  uploadBtn.textContent = "Uploading..."

  /* ===== SAFE FILE NAME ===== */
  const safeFileName = file.name
    .toLowerCase()
    .replace(/\s+/g, "_")
    .replace(/[^a-z0-9_.-]/g, "")

  const filePath = `sheets/${IDACC}/${Date.now()}_${safeFileName}`

  /* ===== UPLOAD PDF ===== */
  const { error: uploadError } = await supabaseClient.storage
    .from("sheet-pdf")
    .upload(filePath, file, {
      contentType: "application/pdf",
      upsert: false
    })

  if (uploadError) {
    console.error(uploadError)
    alert(uploadError.message)
    uploadBtn.disabled = false
    uploadBtn.textContent = "UPLOAD"
    return
  }

  /* ===== INSERT DB ===== */
  const { error: insertError } = await supabaseClient
    .from("Sheet")
    .insert({
      sheet_name: sheetName,
      description: sheetDesc,
      file_path: filePath,
      idacc: IDACC,
      idsubject: idsubject,
      idmajor: IDMAJOR,
      idprofessor: idprofessor
    })

  if (insertError) {
    console.error(insertError)
    alert(insertError.message)
    uploadBtn.disabled = false
    uploadBtn.textContent = "UPLOAD"
    return
  }

  alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ")
  uploadBtn.disabled = false
  uploadBtn.textContent = "UPLOAD"
}
</script>

</body>
</html>

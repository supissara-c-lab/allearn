<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ชีทตามชั้นปี | Allearn</title>

<link rel="stylesheet" href="Allearn_header.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:'Kanit',sans-serif;
  background:#f5f7fa;
  margin:0;
  background-image:linear-gradient(#e0e7ef 1px,transparent 1px);
  background-size:100% 40px;
}

/* ===== TITLE ===== */
.page-title{
  max-width:1100px;
  margin:50px auto 20px;
  padding:40px;
  background:white;
  border-radius:30px;
  box-shadow:0 10px 30px rgba(0,0,0,.05);
}

.page-title h1{
  margin:0 0 8px;
  color:#456E94;
}

.page-title p{
  margin:0;
  color:#777;
}

/* ===== FILE AREA ===== */
.file-area{
  max-width:1100px;
  margin:0 auto 80px;
  padding:0 80px;
}

.file-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:30px 0 18px;
}

.file-label{
  padding:8px 20px;
  border-radius:20px;
  color:white;
  background:#4b56c0;
}

.file-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:26px;
}

.file-card{
  background:white;
  border-radius:18px;
  padding:10px;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
  text-decoration:none;
  color:#000;
  transition:.2s ease;
}

.file-card:hover{
  transform:translateY(-6px);
}

.file-card img{
  width:100%;
  height:160px;
  object-fit:cover;
  border-radius:12px;
}

.file-card p{
  margin:10px 0 0;
  font-size:13px;
  text-align:center;
}
</style>
</head>

<body>

<div id="header"></div>

<section class="page-title">
  <h1 id="yearTitle">กำลังโหลด…</h1>
  <p id="yearSubtitle"></p>
</section>

<div class="file-area">
  <div class="file-header"></div>

  <div class="file-grid" id="sheetGrid"></div>
</div>

<script>
// ===== LOAD HEADER =====
fetch("Allearn_header.html")
  .then(r=>r.text())
  .then(t=>document.getElementById("header").innerHTML=t)

// ===== SUPABASE =====
const supabaseClient = supabase.createClient(
  "https://ctfrqwehpvpldtiojedb.supabase.co",
  "sb_publishable_YHDQnG7VsNgb4O4i6MPN5g_lgU5eOGI"
)

// ===== GET YEAR =====
const params = new URLSearchParams(window.location.search)
const IDYEAR = params.get("idyear")

const yearMap = {
  Y01:"ชั้นปีที่ 1",
  Y02:"ชั้นปีที่ 2",
  Y03:"ชั้นปีที่ 3",
  Y04:"ชั้นปีที่ 4"
}

const titleEl = document.getElementById("yearTitle")
const subEl   = document.getElementById("yearSubtitle")
const grid    = document.getElementById("sheetGrid")

if(!IDYEAR){
  titleEl.textContent = "ไม่พบชั้นปี"
  throw new Error("no idyear")
}

titleEl.textContent = yearMap[IDYEAR]
subEl.textContent   = "รวมชีทจากทุกวิชาในชั้นปีนี้"

// ===== LOAD SHEET BY SUBJECT =====
async function loadSheets(){

  // 1️⃣ ดึงวิชาในปีนี้
  const { data: subjects, error: subErr } = await supabaseClient
    .from("Subject")
    .select("idsubject")
    .eq("idyear", IDYEAR)

  if(subErr || subjects.length === 0){
    grid.innerHTML = "<p>ไม่พบวิชาในชั้นปีนี้</p>"
    return
  }

  const subjectIds = subjects.map(s => s.idsubject)

  const { data: sheets, error: sheetErr } = await supabaseClient
    .from("Sheet")
    .select("idsheet, sheet_name")
    .in("idsubject", subjectIds)
    .order("idsheet", { ascending:false })

  if(sheetErr){
    console.error(sheetErr)
    grid.innerHTML = "<p>เกิดข้อผิดพลาด</p>"
    return
  }

  if(sheets.length === 0){
    grid.innerHTML = "<p style='color:#888'>ยังไม่มีชีทในชั้นปีนี้</p>"
    return
  }

  grid.innerHTML = ""

  sheets.forEach(s=>{
    const card = document.createElement("a")
    card.className = "file-card"
    card.href = `Allearn_content.html?idsheet=${s.idsheet}`
    card.innerHTML = `
      <img src="Exsheet.png">
      <p>${s.sheet_name}</p>
    `
    grid.appendChild(card)
  })
}

loadSheets()
</script>

</body>
</html>

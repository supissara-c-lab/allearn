<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>บัญชีของฉัน | Allearn</title>

<link rel="stylesheet" href="Allearn_header.css">
<link rel="stylesheet" href="Allearn_speech.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family: 'Kanit', sans-serif;
  background:#f5f7fa;
  margin:0;
}

/* ===== PROFILE ===== */
.profile-detail{
  display:flex;
  gap:50px;
  padding:60px 80px;
  max-width:1100px;
  margin:40px auto;
  background:#fff;
  border-radius:30px;
}

.profile-left{
  display:flex;
  flex-direction:column;
  align-items:center;
}

.profile-left img{
  width:240px;
  height:300px;
  object-fit:cover;
  border-radius:18px;
}

.logout-btn{
  margin-top:20px;
  padding:10px 28px;
  border:none;
  border-radius:22px;
  background:#ff6b6b;
  color:#fff;
  cursor:pointer;
}

.info{
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* ===== FILE ===== */
.file-area{
  max-width:1100px;
  margin:0 auto 80px;
  padding:0 80px;
}

/* label + button */
.file-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:30px 0 18px;
}

.file-label{
  display:inline-block;
  padding:8px 20px;
  border-radius:20px;
  color:white;
}

.blue-bg{ background:#4b56c0; }
.blue{ background:#2f6bff; color:#fff }
.yellow{ background:#f7d046; color:#000 }
.babyblue{background:#b1e4eb; color:#000;}

.upload-btn{
  padding:8px 22px;
  border-radius:20px;
  background: #fbbf24;
  color:#fff;
  text-decoration:none;
  font-size:14px;
  font-weight:500;
}

.upload-btn:hover{
  opacity:0.9;
}

.tag-row{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.tag{
  padding:6px 16px;
  border-radius:999px;
  font-size:14px;
  font-weight:500;
}

.file-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:26px;
}

.file-card{
  background:white;
  border-radius:18px;
  padding:10px;
  box-shadow:0 6px 18px rgba(0,0,0,0.12);
  text-decoration:none;
  color:#000;
}

.file-card img{
  width:100%;
  height:160px;
  object-fit:cover;
  border-radius:12px;
}

.file-card p{
  margin:10px 0 0;
  font-size:13px;
  text-align:center;
}
</style>
</head>

<body>

<div id="header"></div>

<section class="profile-detail">

  <div class="profile-left">
    <img src="Exprofile.png">
    <button class="logout-btn" onclick="logout()">Log out</button>
  </div>

  <div class="info">

    <div id="speechBox"></div>
    <p id="sessionEcho" style="text-align:center;color:#2f6bff;font-weight:600;"></p>
    <div class="tag-row">
      <div class="tag blue" id="majorTag">กำลังโหลด...</div>
      <div class="tag babyblue" id="yearTag">กำลังโหลด...</div>
    </div>

    <strong>ชีทที่เพิ่มโดยฉัน</strong>
    <p id="sheetCount">0</p>

    <a href="Allearn_admin.html" class="upload-btn">ADMIN</a>
  </div>

</section>

<div class="file-area">

  <div class="file-header">
    <div class="file-label blue-bg">ชีทที่เพิ่มโดยฉัน</div>
    <a href="Allearn_uploadui.html" class="upload-btn">+ เพิ่มชีท</a>
  </div>

  <div class="file-grid" id="mySheetGrid"></div>
</div>

<script>
// ===== LOAD HEADER =====
fetch("Allearn_header.html")
  .then(r => r.text())
  .then(t => document.getElementById("header").innerHTML = t)

// ===== SUPABASE =====
const supabaseClient = supabase.createClient(
  "https://ctfrqwehpvpldtiojedb.supabase.co",
  "sb_publishable_YHDQnG7VsNgb4O4i6MPN5g_lgU5eOGI"
)

// ===== SESSION =====
const IDACC = sessionStorage.getItem("idacc")
document.getElementById("sessionEcho").innerText =
  IDACC ? `SESSION เข้าแล้ว → idacc = ${IDACC}` : "ยังไม่มี SESSION"

if (!IDACC) {
  alert("กรุณาเข้าสู่ระบบก่อน")
  location.href = "Allearn_login.html"
}

// ===== ELEMENT =====
const grid = document.getElementById("mySheetGrid")
const sheetCount = document.getElementById("sheetCount")
let userNameEl

// ===== LOAD SPEECH + DATA =====
fetch("Allearn_speech-profile.html")
  .then(r => r.text())
  .then(t => {
    document.getElementById("speechBox").innerHTML = t
    userNameEl = document.getElementById("userName")
    loadUser()
    loadMySheets()
  })

// ===== LOAD USER =====
async function loadUser(){
  const { data, error } = await supabaseClient
    .from("Account")
    .select("name, surname, idmajor, idyear")
    .eq("idacc", IDACC)
    .single()
    

  if (error) {
    console.error(error)
    return
  }

  userNameEl.textContent = `${data.name} ${data.surname}`

  document.getElementById("majorTag").textContent =
    data.idmajor || "ไม่ระบุสาขา"

  document.getElementById("yearTag").textContent =
    data.idyear || "ไม่ระบุชั้นปี"
}


// ===== LOAD SHEETS =====
async function loadMySheets(){
  const { data, error } = await supabaseClient
    .from("Sheet")
    .select("idsheet, sheet_name")
    .eq("idacc", IDACC)
    .order("idsheet", { ascending:false })

  if (error) return console.error(error)

  sheetCount.textContent = data.length
  grid.innerHTML = ""

  data.forEach(s => {
    const card = document.createElement("a")
    card.className = "file-card"
    card.href = `Allearn_content.html?idsheet=${s.idsheet}`
    card.innerHTML = `
      <img src="Exsheet.png">
      <p>${s.sheet_name}</p>
    `
    grid.appendChild(card)
  })
}

// ===== LOGOUT =====
function logout(){
  sessionStorage.clear()
  location.href = "Allearn_login.html"
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Sheet Final UI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    /* ================= CSS STYLES (‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ) ================= */
    :root {
        --card-bg: #FFF9E5;
        --primary-blue: #456E94;
        --tag-blue: #60a5fa;
        --tag-red: #f87171;
        --tag-yellow: #fbbf24;
    }

    body {
        font-family: 'Kanit', sans-serif;
        margin: 0; padding: 40px 20px;
        min-height: 100vh;
        background-color: #cbdcf0;
        background-image: linear-gradient(#9fbfd6 1px, transparent 1px);
        background-size: 100% 35px;
        display: flex; justify-content: center; align-items: center;
    }

    .container { width: 100%; max-width: 800px; }

    .sheet-card {
        background-color: var(--card-bg);
        border-radius: 40px;
        padding: 40px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        display: flex; flex-direction: row; gap: 30px;
        position: relative;
    }

    /* Left: Upload Zone */
    .upload-section {
        flex: 0 0 150px;
        display: flex; flex-direction: column; align-items: center; padding-top: 20px;
    }
    .file-drop-area {
        width: 120px; height: 140px;
        background-color: #fff;
        border: 2px dashed #ccc;
        border-radius: 15px;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        cursor: pointer; transition: 0.3s;
        text-align: center; padding: 10px;
        color: #888; font-size: 0.9rem;
        position: relative; overflow: hidden;
    }
    .file-drop-area:hover { border-color: var(--primary-blue); color: var(--primary-blue); }
    .file-drop-area input[type="file"] { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .file-icon { font-size: 40px; margin-bottom: 10px; }

    /* Right: Info Form */
    .info-section { flex: 1; display: flex; flex-direction: column; gap: 15px; }

    /* Title Bubble */
    .title-wrapper { display: flex; align-items: center; margin-bottom: 5px; }
    .title-bubble {
        background-color: var(--primary-blue); color: white;
        padding: 15px 30px; border-radius: 20px;
        position: relative; font-weight: 600; font-size: 1.2rem;
        width: 100%; display: flex; align-items: center;
    }
    .title-bubble::before {
        content: ''; position: absolute; left: -10px; top: 50%; transform: translateY(-50%);
        border-style: solid; border-width: 10px 10px 10px 0;
        border-color: transparent var(--primary-blue) transparent transparent;
    }
    input.title-input {
        background: transparent; border: none; color: white;
        font-family: 'Kanit', sans-serif; font-size: 1.2rem;
        font-weight: 600; width: 100%; outline: none;
    }
    input.title-input::placeholder { color: rgba(255,255,255,0.7); }

    /* Select Dropdowns */
    .tags-row { display: flex; flex-wrap: wrap; gap: 10px; }
    .custom-select-wrapper { position: relative; }
    select {
        appearance: none; border: none;
        padding: 8px 30px 8px 15px; border-radius: 20px;
        font-family: 'Kanit', sans-serif; font-size: 0.9rem;
        color: white; font-weight: 500; cursor: pointer;
        outline: none; min-width: 120px;
    }
    select option { color: #333 !important; background-color: #fff !important; }
    #subjectSelect { background-color: var(--tag-blue); }
    #professorSelect { background-color: var(--tag-red); }

    /* === Description Box (White Card Style) === */
    .desc-wrapper { margin-top: 5px; }
    textarea {
        width: 100%;
        box-sizing: border-box; 
        background-color: #fff; 
        border: 2px solid transparent; 
        border-radius: 20px; 
        padding: 15px; 
        font-family: 'Kanit', sans-serif;
        font-size: 1rem;
        color: #333;
        resize: vertical;
        outline: none;
        min-height: 120px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        transition: 0.2s;
    }
    textarea:focus {
        border-color: var(--tag-blue);
        box-shadow: 0 4px 10px rgba(96, 165, 250, 0.2);
    }
    textarea::placeholder { color: #aaa; }

    /* Upload Button */
    .action-row { display: flex; justify-content: flex-end; margin-top: 10px; }
    button#uploadBtn {
        background-color: var(--tag-yellow); color: #fff; border: none;
        padding: 10px 30px; border-radius: 20px;
        font-family: 'Kanit', sans-serif; font-weight: 600; font-size: 1rem;
        cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;
    }
    button#uploadBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,0.15); }
    button#uploadBtn:disabled { background-color: #ddd; cursor: not-allowed; transform: none; }

    @media (max-width: 600px) {
        .sheet-card { flex-direction: column; padding: 20px; }
        .upload-section { width: 100%; flex-direction: row; justify-content: center; padding-top: 0; margin-bottom: 20px; }
    }
</style>
</head>

<body>

<div class="container">
    <div class="sheet-card">
        
        <div class="upload-section">
            <div class="file-drop-area">
                <span class="file-icon">üìÑ</span>
                <span class="file-msg" id="fileNameDisplay">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF</span>
                <input type="file" id="pdfFile" accept="application/pdf">
            </div>
        </div>

        <div class="info-section">
            
            <div class="title-wrapper">
                <div class="title-bubble">
                    <input type="text" id="sheetName" class="title-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...">
                </div>
            </div>

            <div class="tags-row">
                <div class="custom-select-wrapper">
                    <select id="subjectSelect">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                    </select>
                </div>
                <div class="custom-select-wrapper">
                    <select id="professorSelect">
                        <option value="">‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤...</option>
                    </select>
                </div>
            </div>

            <div class="desc-wrapper">
                <textarea id="sheetDesc" rows="4" 
                    placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£? ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£? ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            </div>

            <div class="action-row">
                <button id="uploadBtn">UPLOAD SHEET</button>
            </div>

        </div>
    </div>
</div>

<script>
/* ================= UI LOGIC ================= */
document.getElementById('pdfFile').addEventListener('change', function(event) {
    const fileName = event.target.files[0]?.name;
    const display = document.getElementById('fileNameDisplay');
    if(fileName) {
        display.textContent = fileName.length > 15 ? fileName.substring(0, 12) + "..." : fileName;
        display.style.color = "#456E94"; display.style.fontWeight = "bold";
    } else {
        display.textContent = "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF"; display.style.color = "#888";
    }
});

/* ================= SUPABASE LOGIC ================= */
const supabaseClient = supabase.createClient(
  "https://ctfrqwehpvpldtiojedb.supabase.co",
  "sb_publishable_YHDQnG7VsNgb4O4i6MPN5g_lgU5eOGI"
)

const IDACC = "f2327b71-2cc2-45ac-9394-f4a8484dde89" 
const IDMAJOR = "M01"
const subjectSelect = document.getElementById("subjectSelect")
const professorSelect = document.getElementById("professorSelect")
const uploadBtn = document.getElementById("uploadBtn")

async function loadSubjects() {
  const { data, error } = await supabaseClient.from("Subject").select("idsubject, subject_name").order("subject_name")
  if (error) { console.error(error); return; }
  data.forEach(s => {
    const opt = document.createElement("option"); opt.value = s.idsubject; opt.textContent = s.subject_name;
    subjectSelect.appendChild(opt)
  })
}
loadSubjects()

subjectSelect.onchange = async () => {
  const idsubject = subjectSelect.value
  professorSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå --</option>`
  if (!idsubject) { professorSelect.innerHTML = `<option value="">‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤...</option>`; return; }

  const { data, error } = await supabaseClient
    .from("professor_subject").select("idprofessor, Professor(name, surname)").eq("idsubject", idsubject)

  if (error || data.length === 0) {
      professorSelect.innerHTML = error ? `<option value="">Error</option>` : `<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option>`;
      return;
  }
  data.forEach(p => {
    if(p.Professor) {
        const opt = document.createElement("option"); opt.value = p.idprofessor;
        opt.textContent = `${p.Professor.name} ${p.Professor.surname}`; professorSelect.appendChild(opt)
    }
  })
}

uploadBtn.onclick = async () => {
  const file = document.getElementById("pdfFile").files[0]
  const sheetName = document.getElementById("sheetName").value.trim()
  const sheetDesc = document.getElementById("sheetDesc").value.trim()
  const idsubject = subjectSelect.value
  const idprofessor = professorSelect.value
  
  if (!file || !sheetName || !idsubject || !idprofessor) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö")
    return
  }
  if (file.type !== "application/pdf") { alert("‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PDF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"); return; }

  uploadBtn.disabled = true; uploadBtn.textContent = "Uploading..."
  const safeFileName = file.name.toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_.-]/g, "")
  const filePath = `sheets/${IDACC}/${Date.now()}_${safeFileName}`

  // 1. Upload
  const { error: uploadError } = await supabaseClient.storage
    .from("sheet-pdf").upload(filePath, file, { contentType: "application/pdf", upsert: false })

  if (uploadError) {
    alert("Upload Failed: " + uploadError.message); uploadBtn.disabled = false; uploadBtn.textContent = "UPLOAD SHEET"; return;
  }

  // 2. Insert DB
  const { error: insertError } = await supabaseClient.from("Sheet").insert({
      sheet_name: sheetName, description: sheetDesc, file_path: filePath,
      idacc: IDACC, idsubject: idsubject, idmajor: IDMAJOR, idprofessor: idprofessor
  })

  if (insertError) {
    alert("Database Error: " + insertError.message); 
    uploadBtn.disabled = false; uploadBtn.textContent = "UPLOAD SHEET"; 
    return;
  }

  alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ")
  location.reload(); 
}
</script>

</body>
</html>